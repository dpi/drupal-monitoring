<?php
/**
 * @file
 * Contains \MonitoringUITest.
 */
use Drupal\monitoring\Sensor\SensorInfo;

/**
 * Tests the Monitoring UI.
 */
class MonitoringUITest extends MonitoringTestBase {

  protected $profile = 'testing';

  static function getInfo() {
    return array(
      'name' => 'Monitoring UI',
      'description' => 'Monitoring UI tests.',
      'group' => 'Monitoring',
    );
  }

  /**
   * {@inheritdoc}
   */
  function setUp() {
    parent::setUp(array('dblog'));
  }

  /**
   *
   */
  function testSensorSettingsUI() {
    $account = $this->drupalCreateUser(array('administer monitoring'));
    $this->drupalLogin($account);

    $info = monitoring_sensor_info();

    // Test sensor exceeds.
    $sensor_info = $info['test_sensor_exceeds'];
    $data = array();
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold) {
      $key = monitoring_sensor_settings_key('test_sensor_exceeds') . '[thresholds][intervals][' . $status . ']';
      $data[$key] = $threshold + 1;
    }
    $this->drupalPost('admin/config/system/monitoring/sensors/test_sensor_exceeds', $data, t('Save'));

    $this->drupalGet('admin/config/system/monitoring/sensors/test_sensor_exceeds');
    $this->assertTitle(t('@label settings (@category) | Drupal', array('@label' => $sensor_info->getLabel(), '@category' => $sensor_info->getCategory())));
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold) {
      $key = monitoring_sensor_settings_key('test_sensor_exceeds') . '[thresholds][intervals][' . $status . ']';
      $this->assertFieldByName($key, $threshold + 1);
    }

    // Test sensor falls.
    $sensor_info = $info['test_sensor_falls'];
    $data = array();
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold) {
      $key = monitoring_sensor_settings_key('test_sensor_falls') . '[thresholds][intervals][' . $status . ']';
      $data[$key] = $threshold + 1;
    }
    $this->drupalPost('admin/config/system/monitoring/sensors/test_sensor_falls', $data, t('Save'));

    $this->drupalGet('admin/config/system/monitoring/sensors/test_sensor_falls');
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold) {
      $key = monitoring_sensor_settings_key('test_sensor_falls') . '[thresholds][intervals][' . $status . ']';
      $this->assertFieldByName($key, $threshold + 1);
    }

    // Test sensor inner interval.
    $sensor_info = $info['test_sensor_inner'];
    $data = array();
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold_inner) {
      $key_inner = monitoring_sensor_settings_key('test_sensor_inner') . '[thresholds][intervals][' . $status . ']';
      $data[$key_inner . '[0]'] = $threshold_inner[0] + 1;
      $data[$key_inner . '[1]'] = $threshold_inner[1] + 1;
      $this->drupalPost('admin/config/system/monitoring/sensors/test_sensor_inner', $data, t('Save'));
    }

    $this->drupalGet('admin/config/system/monitoring/sensors/test_sensor_inner');
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold) {
      $key = monitoring_sensor_settings_key('test_sensor_inner') . '[thresholds][intervals][' . $status . ']';
      $this->assertFieldByName($key . '[0]', $threshold[0] + 1);
      $this->assertFieldByName($key . '[1]', $threshold[1] + 1);
    }

    // Test sensor outer interval.
    $sensor_info = $info['test_sensor_outer'];
    $data = array();
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold_outer) {
      $key_outer = monitoring_sensor_settings_key('test_sensor_outer') . '[thresholds][intervals][' . $status . ']';
      $data[$key_outer . '[0]'] = $threshold_outer[0] + 1;
      $data[$key_outer . '[1]'] = $threshold_outer[1] + 1;
    }
    $this->drupalPost('admin/config/system/monitoring/sensors/test_sensor_outer', $data, t('Save'));

    $this->drupalGet('admin/config/system/monitoring/sensors/test_sensor_outer');
    foreach ($sensor_info->getThresholdsIntervals() as $status => $threshold) {
      $key = monitoring_sensor_settings_key('test_sensor_outer') . '[thresholds][intervals][' . $status . ']';
      $this->assertFieldByName($key . '[0]', $threshold[0] + 1);
      $this->assertFieldByName($key . '[1]', $threshold[1] + 1);
    }

    // Test that trying to access the sensors settings page of a non-existing
    // sensor results in a page not found response.
    $this->drupalGet('admin/config/system/monitoring/sensors/non_existing_sensor');
    $this->assertResponse(404);
  }

  /**
   * Tests the time interval settings UI of the database aggregator sensor.
   */
  function testAggregateSensorTimeIntervalConfig() {
    $account = $this->drupalCreateUser(array('administer monitoring', 'monitoring reports'));
    $this->drupalLogin($account);

    // Visit the overview and make sure the sensor is displayed.
    $this->drupalGet('admin/reports/monitoring');
    $this->assertText('0 druplicons in 1 day');

    $form_key = monitoring_sensor_settings_key('db_aggregate_test');
    $sensor_info = $this->sensorManager->getSensorInfoByName('db_aggregate_test');
    $this->drupalGet('admin/config/system/monitoring/sensors/db_aggregate_test');
    // Test for the default value.
    $this->assertFieldByName($form_key . '[time_interval_value]', $sensor_info->getTimeIntervalValue());

    // Update the time interval and test for the updated value.
    $time_interval = 10800;
    $this->drupalPost('admin/config/system/monitoring/sensors/db_aggregate_test', array(
      $form_key . '[time_interval_value]' => $time_interval,
    ), t('Save'));

    $this->sensorManager->resetCache();
    $sensor_info = $this->sensorManager->getSensorInfoByName('db_aggregate_test');
    $this->assertEqual($sensor_info->getTimeIntervalValue(), $time_interval);

    // Check the sensor overview to verify that the sensor result is
    // recalculated and the new sensor message is displayed.
    $this->drupalGet('admin/reports/monitoring');
    $this->assertText('0 druplicons in 3 hours');

    // Update the time interval and set it to no restriction.
    $time_interval = 0;
    $this->drupalPost('admin/config/system/monitoring/sensors/db_aggregate_test', array(
      $form_key . '[time_interval_value]' => $time_interval,
    ), t('Save'));

    $this->sensorManager->resetCache();
    $sensor_info = $this->sensorManager->getSensorInfoByName('db_aggregate_test');
    $this->assertEqual($sensor_info->getTimeIntervalValue(), $time_interval);

    // Visit the overview and make sure that no time interval is displayed.
    $this->drupalGet('admin/reports/monitoring');
    $this->assertText('0 druplicons');
    $this->assertNoText('0 druplicons in');
  }

  function testSensorOverviewPage() {
    $account = $this->drupalCreateUser(array('monitoring reports'));
    $this->drupalLogin($account);

    $this->drupalGet('admin/reports/monitoring');

    $tbody = $this->xpath('//table[@id="monitoring-sensors-overview"]/tbody');
    $rows = $tbody[0];

    $i = 0;
    foreach (monitoring_sensor_info_by_categories() as $category => $category_sensor_info) {
      $tr = $rows->tr[$i];
      $this->assertEqual($category, $tr->td->h3);

      foreach ($category_sensor_info as $sensor_info) {
        $i++;
        $tr = $rows->tr[$i];
        $this->assertEqual($tr->td[0]->span, $sensor_info->getLabel());
      }

      $i++;
    }

    $sensor_info = monitoring_sensor_info('test_sensor');
    $this->drupalGet('admin/reports/monitoring/sensors/test_sensor');
    $this->assertTitle(t('@label (@category) | Drupal', array('@label' => $sensor_info->getLabel(), '@category' => $sensor_info->getCategory())));

    // Test that accessing a disabled or not-existing sensor results in a page
    // not found response.
    $this->sensorManager->disableSensor('test_sensor');
    $this->drupalGet('admin/reports/monitoring/sensors/test_sensor');
    $this->assertResponse(404);

    $this->drupalGet('admin/reports/monitoring/sensors/non_existing_sensor');
    $this->assertResponse(404);
  }

  /**
   * Tests the force execute all command.
   */
  function testForceExecuteAll() {
    $account = $this->drupalCreateUser(array('monitoring force run', 'monitoring reports'));
    $this->drupalLogin($account);

    // Set a specific test sensor result to look for.
    $test_sensor_result_data = array(
      'sensor_message' => 'First message',
    );
    variable_set('test_sensor_result_data', $test_sensor_result_data);

    $this->drupalGet('admin/reports/monitoring');
    $this->assertText('First message');

    // Update the sensor message.
    $test_sensor_result_data['sensor_message'] = 'Second message';
    variable_set('test_sensor_result_data', $test_sensor_result_data);

    // Access the page again, we should still see the first message because the
    // cached result is returned.
    $this->drupalGet('admin/reports/monitoring');
    $this->assertText('First message');

    // Force sensor execution, the changed message should be displayed now.
    $this->clickLink(t('Force execute all'));
    $this->assertNoText('First message');
    $this->assertText('Second message');
  }

}
